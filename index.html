<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’¬ Ù…ÙˆÙ‚Ø¹ ØªÙˆØ§ØµÙ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@200;400;500;600;700;800;900&display=swap");
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    
    /* Ø®Ù„ÙÙŠØ© ÙˆØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø³Ù… */
    body { 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh; 
        background: url("https://i.pinimg.com/originals/d7/b9/0c/d7b90cc80898e8823455a127945719af.jpg") no-repeat; 
        background-size: cover; 
        background-position: center; 
        overflow-y: auto; 
        position: relative;
    }

    /* --- Sidebar Styles --- */
    .sidebar-toggle {
        position: fixed;
        top: 15px;
        right: 20px;
        font-size: 2.2rem;
        color: white;
        background-color: #002b4d;
        border: none;
        padding: 5px 10px;
        border-radius: 8px;
        cursor: pointer;
        z-index: 1002;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .sidebar-toggle:focus { outline: none; }

    .sidebar {
        height: 100%;
        width: 0;
        position: fixed;
        z-index: 1001;
        top: 0;
        right: 0;
        background-color: #00233a;
        overflow-x: hidden;
        transition: 0.35s ease-out;
        padding-top: 70px;
        direction: rtl;
        box-shadow: -5px 0 15px rgba(0,0,0,0.2);
    }
    .sidebar.open {
        width: 260px;
    }
    .sidebar a {
        padding: 12px 15px 12px 30px;
        text-decoration: none;
        font-size: 1.15rem;
        color: #b0bec5;
        display: block;
        transition: 0.2s;
        border-bottom: 1px solid #002b4d;
    }
    .sidebar a:last-child {
        border-bottom: none;
    }
    .sidebar a:hover, .sidebar a.active-nav-link {
        color: #fff;
        background-color: #003B73;
        font-weight: bold;
    }
    .sidebar .sidebar-close-btn {
        position: absolute;
        top: 15px;
        left: 25px;
        font-size: 2rem;
        color: #b0bec5;
        cursor: pointer;
    }
     .sidebar .sidebar-close-btn:hover {
        color: #fff;
     }

    #admin-button-sidebar {
        background-color: rgba(220, 53, 69, 0.7);
        color: white !important;
    }
    #admin-button-sidebar:hover {
         background-color: #dc3545;
    }

    /* --- General Styles --- */
    .wrapper { 
        margin-top: 80px; 
        width: 420px; 
        max-width: 90%; 
        background-color: transparent; 
        border: 2px solid rgba(255, 255, 255, 0.2); 
        backdrop-filter: blur(15px); 
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); 
        color: #fff; 
        border-radius: 16px; 
        padding: 20px 30px; 
        direction: rtl; 
    }
    .wrapper h1 { font-size: 30px; text-align: center; margin-bottom:20px;}
    .wrapper .input-box { width: 100%; height: 50px; position: relative; margin: 30px 0; }
    .input-box input { width: 100%; height: 100%; background: transparent; border: none; outline: none; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 40px; font-size: 16px; color: #fff; padding: 20px 45px 20px 20px; text-align: right; direction: rtl; }
    .input-box input::placeholder { color: #fff; text-align: right; }
    .input-box i { position: absolute; top: 50%; transform: translateY(-50%); font-size: 20px; left: 20px; }
    .wrapper .remember-forgot { display: flex; justify-content: space-between; font-size: 14px; margin: -15px 0 15px; direction: rtl; }
    .wrapper .btn { width: 100%; height: 45px; background: #fff; border: none; outline: none; border-radius: 40px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); cursor: pointer; font-size: 16px; color: #333; font-weight: 600; margin-top: 15px; display: flex; align-items: center; justify-content: center;}
    .wrapper .btn:disabled { background: #aaa; color: #666; cursor: not-allowed; }
    .wrapper .register-link { text-align: center; font-size: 14px; margin: 20px 0 15px; }
    .wrapper .register-link p a { color: #fff; text-decoration: none; font-weight: 600; }
    .wrapper .register-link p a:hover { text-decoration: underline; }

    #auth-status { margin-top:10px; padding: 8px; border-radius: 8px; font-weight: 500; min-height: 1.5em; text-align: center; color: #fff; font-size: 0.9em;}
    #auth-status.success { background-color: rgba(40, 167, 69, 0.3); border: 1px solid rgba(40, 167, 69, 0.6); }
    #auth-status.error { background-color: rgba(220, 53, 69, 0.3); border: 1px solid rgba(220, 53, 69, 0.6); }
    #auth-status.info { background-color: rgba(23, 162, 184, 0.3); border: 1px solid rgba(23, 162, 184, 0.6); }

    nav#main-nav { display: none; }

    section { display: none; padding: 20px; max-width: 600px; margin: 20px auto; margin-top: 80px; background: rgba(255, 255, 255, 0.95); color: #333; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); direction: rtl; }
    section.active { display:block !important; }
    section#login.active { background: transparent; box-shadow: none; border: none; padding: 0; max-width: none; }
    section h2 { margin-top: 0; color: #003B73; text-align: center; margin-bottom: 20px; }
    
    /* General Buttons inside sections */
    section:not(#login) button { padding:10px 15px; margin:8px 4px; font-size:0.9rem; cursor:pointer; border:none; border-radius:8px; background:#005A9C; color:white; transition:background .2s; }
    section:not(#login) button:hover { background:#003B73; }
    section:not(#login) button:disabled { background:#ccc; cursor:not-allowed; }

    .hidden-by-auth { display: none !important; }
    .button-text { margin: 0 5px; }

    /* Settings Styles */
    #settings p, #settings .input-group-settings { margin-bottom: 15px; }
    #settings .info-value { font-weight: bold; color: #005A9C; }
    #settings-status, #profile-settings-status { margin-top: 15px; font-size: 0.9em; min-height: 1.2em; text-align: center;}
    #settings label { display: block; margin-bottom: 5px; font-weight: 500;}
    #settings input[type="text"], #settings textarea {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 1rem;
        direction: rtl;
    }
    #settings textarea { min-height: 80px; resize: vertical;}

    /* Admin Area Styles */
    #admin-area h3 { margin-top: 20px; margin-bottom: 10px; color: #003B73; }
    #admin-users-list-container ul { list-style: none; padding: 0; }
    #admin-users-list-container li { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    #admin-users-list-container li span { margin-right: 10px; word-break: break-all; }
    #admin-users-list-container li .user-actions button { font-size: 0.8rem; padding: 5px 8px; margin-left: 5px;}
    #admin-user-details-container p { margin-bottom: 5px; }
    .banned-user-indicator { color: red; font-weight: bold; }

    /* User Search and Profile Styles */
    #user-search .input-group-search { display: flex; align-items: center; margin-bottom: 15px;}
    #user-search input[type="text"] { width: calc(100% - 90px); padding: 10px; border-radius: 0 6px 6px 0; border: 1px solid #ccc; font-size: 1rem; display: inline-block; vertical-align: middle; order:1; direction: rtl;}
    #user-search button#btn-user-search { width: 80px; border-radius: 6px 0 0 6px; display: inline-block; vertical-align: middle; height: 40px; line-height: 1; padding-top: 0; padding-bottom:0; order:2; margin-left: -1px; }
    #search-results-container { margin-top: 20px; }
    .user-profile-card {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .user-profile-card .profile-pic-default {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #005A9C;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        flex-shrink: 0;
    }
    .user-profile-card .user-info { flex-grow: 1; }
    .user-profile-card .user-info p { margin: 2px 0; }
    .user-profile-card .user-info .username-search { font-weight: bold; color: #003B73; }
    .user-profile-card .user-info .bio-search { font-size: 0.85em; color: #555; margin-top: 4px; max-height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;}
    .user-profile-card .user-actions { flex-shrink: 0; display: flex; flex-direction: column; gap: 5px; }
    .user-profile-card .user-actions button { font-size: 0.8rem; padding: 5px 8px; min-width: 90px; text-align: center;}
    #user-search-status { margin-top:15px; font-size:0.9em; min-height:1.2em; text-align: center; }

    /* Friends Section Styles */
    #friends-section .tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ccc; }
    #friends-section .tabs button {
        background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 1rem; color: #555;
        border-bottom: 3px solid transparent; margin-bottom: -1px; /* For active tab underline */
    }
    #friends-section .tabs button.active { color: #003B73; border-bottom-color: #003B73; font-weight: bold;}
    .friends-list-item {
        background-color: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 6px;
        padding: 10px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
    }
    .friends-list-item .user-info p { margin: 0; }
    .friends-list-item .user-info .username-friend { font-weight: bold; }
    .friends-list-item .friend-actions button { font-size: 0.8rem; padding: 5px 8px; margin-left: 5px; }
    .friends-list-status { margin-top: 10px; font-size: 0.9em; text-align: center; }


    /* Chat Styles */
    #chat-room h2 { margin-bottom: 10px; }
    #messages-container {
        height: 350px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
        display: flex;
        flex-direction: column;
        direction: ltr;
    }
    .message-bubble {
        padding: 8px 12px;
        border-radius: 18px;
        margin-bottom: 8px;
        max-width: 75%;
        word-wrap: break-word;
        font-size: 0.95rem;
        line-height: 1.4;
    }
    .message-bubble.sent {
        background-color: #005A9C;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
        text-align: right;
        direction: rtl;
    }
    .message-bubble.received {
        background-color: #e9e9e9;
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 5px;
        text-align: right;
        direction: rtl;
    }
    .message-timestamp {
        font-size: 0.7em;
        color: #999;
        display: block;
        margin-top: 3px;
    }
    .sent .message-timestamp { text-align: left; color: #cce7ff; }
    .received .message-timestamp { text-align: left; }

    #chat-input-area { display: flex; }
    #chat-input-area input[type="text"] {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 0 20px 20px 0;
        font-size: 1rem;
        direction: rtl;
    }
    #chat-input-area button {
        padding: 10px 15px;
        border-radius: 20px 0 0 20px;
        margin-right: -1px;
    }
    #chat-room-exit-button { margin-top: 15px; }


  </style>
</head>
<body>

  <button class="sidebar-toggle" id="sidebar-toggle-button">
    <i class='bx bx-menu'></i>
  </button>

  <div class="sidebar" id="mySidebar">
    <a href="javascript:void(0)" class="sidebar-close-btn" id="sidebar-close-button">Ã—</a>
    <a href="#login" id="nav-login-link-sidebar">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
    <a href="#user-search" id="nav-user-search-link-sidebar" style="display:none;">Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…</a>
    <a href="#friends-section" id="nav-friends-link-sidebar" style="display:none;">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</a>
    <a href="#settings" id="nav-settings-link-sidebar" style="display:none;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    <a href="#" id="admin-button-sidebar" style="display:none;" onclick="showAdminArea(event)">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</a>
  </div>

  <section id="login">
    <div class="wrapper">
        <form action="javascript:void(0);">
            <h1 id="login-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
            <div id="auth-form-fields">
                <div class="input-box">
                    <input type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" id="login-email" required>
                    <i class='bx bxs-user'></i>
                </div>
                <div class="input-box">
                    <input type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" id="login-password" required>
                    <i class='bx bxs-lock-alt'></i>
                </div>
            </div>
            <button type="button" class="btn" id="btn-main-action">
                 <span class="button-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
            </button>
            <div class="register-link">
                <p id="toggle-auth-mode-text">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" id="toggle-auth-mode-link-inner">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a></p>
            </div>
            <button type="button" class="btn" id="btn-logout" style="display:none; margin-top: 10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </form>
        <div id="auth-status" class="info">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯.</div>
    </div>
  </section>

  <section id="settings" class="game-section">
      <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© âš™ï¸</h2>
      <p>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: <span id="settings-user-email" class="info-value"></span></p>

      <div class="input-group-settings">
          <label for="settings-username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙØ±ÙŠØ¯ØŒ Ø­Ø±ÙˆÙ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… Ùˆ "_"):</label>
          <input type="text" id="settings-username" placeholder="Ù…Ø«Ø§Ù„: gamer123">
      </div>
      <div class="input-group-settings">
          <label for="settings-display-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ (Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¢Ø®Ø±ÙŠÙ†):</label>
          <input type="text" id="settings-display-name" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø±">
      </div>
      <div class="input-group-settings">
          <label for="settings-bio">Ù†Ø¨Ø°Ø© ØªØ¹Ø±ÙŠÙÙŠØ© (Bio):</label>
          <textarea id="settings-bio" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ù‹Ø§ Ø¹Ù† Ù†ÙØ³Ùƒ..."></textarea>
      </div>
      <button id="btn-save-settings">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
      <div id="profile-settings-status" class="info"></div>
      <hr style="margin: 20px 0;">
      <button id="btn-change-password">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
      <div id="settings-status" class="info"></div>
  </section>

  <section id="user-search" class="game-section">
      <h2>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ğŸ”</h2>
      <div class="input-group-search">
          <input type="text" id="user-search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¨Ø­Ø«...">
          <button id="btn-user-search">Ø¨Ø­Ø«</button>
      </div>
      <div id="user-search-status" class="info"></div>
      <div id="search-results-container">
      </div>
  </section>

  <section id="friends-section" class="game-section">
      <h2>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© ğŸ¤</h2>
      <div class="tabs">
          <button id="tab-my-friends" class="active" onclick="showFriendsTab('my-friends')">Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</button>
          <button id="tab-received-requests" onclick="showFriendsTab('received-requests')">Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø±Ø¯Ø© (<span id="received-requests-count">0</span>)</button>
          <button id="tab-sent-requests" onclick="showFriendsTab('sent-requests')">Ø·Ù„Ø¨Ø§Øª Ù…Ø±Ø³Ù„Ø©</button>
      </div>
      <div id="my-friends-list" class="friends-tab-content"></div>
      <div id="received-requests-list" class="friends-tab-content" style="display:none;"></div>
      <div id="sent-requests-list" class="friends-tab-content" style="display:none;"></div>
      <div class="friends-list-status info"></div>
  </section>


  <section id="chat-room" class="game-section" style="display:none;">
      <h2 id="chat-room-header">Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ...</h2>
      <div id="messages-container">
      </div>
      <div id="chat-input-area">
          <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
          <button id="send-message-button">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
      <button id="chat-room-exit-button">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
  </section>


  <section id="admin-area" class="game-section" style="display:none;">
      <h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† ğŸ‘‘</h2>
      <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø£Ø¯Ù…Ù†!</p>

      <div id="admin-users-section">
          <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
          <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> "Ø§Ù„Ø­Ø¸Ø±" Ù‡Ù†Ø§ Ù‡Ùˆ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ ÙˆÙ„Ø§ ÙŠØ­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Firebase.</p>
          <div id="admin-users-list-container">
              <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
          </div>
          <div id="admin-user-details-container" style="display:none; margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
              <h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</h4>
              <p id="details-email"></p>
              <p id="details-uid"></p>
              <p id="details-created"></p>
              <p id="details-last-login"></p>
              <p id="details-banned-status"></p>
              <p id="details-username"></p>
              <p id="details-displayName"></p>
              <p id="details-bio"></p>
              <button id="details-close-btn">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
          </div>
      </div>
      <div id="admin-status" class="info" style="margin-top: 20px;"></div>
  </section>


  <audio id="snd-click" src="https://actions.google.com/sounds/v1/alarms/button_click.ogg"></audio>
  <audio id="snd-win" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="snd-lose" src="https://actions.google.com/sounds/v1/cartoon/cartoon_cowbell.ogg"></audio>
  <audio id="snd-message" src="https://actions.google.com/sounds/v1/communication/connect_alert.ogg"></audio>
  <audio id="snd-friend-request" src="https://actions.google.com/sounds/v1/notifications/quick_notification.ogg"></audio>


  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>


  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyDLzpa2HYzJZdZvY_YuviKZ6Zg0FhWTfJw",
        authDomain: "my-site-cdd00.firebaseapp.com",
        projectId: "my-site-cdd00",
        storageBucket: "my-site-cdd00.firebasestorage.app",
        messagingSenderId: "514123463555",
        appId: "1:514123463555:web:8499c5bde152537a3dd4b6",
        measurementId: "G-3Y7SYCE0NZ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const ADMIN_EMAIL = "ka6761386@gmail.com";
    let currentUserIsAdmin = false;
    let currentChatRoomId = null;
    let currentChatWithUserId = null;
    let currentChatWithDisplayName = null;
    let chatMessagesListener = null;
    let friendsListener = null;
    let receivedRequestsListener = null;
    let sentRequestsListener = null;
    let currentUserData = null;


    document.addEventListener('DOMContentLoaded', () => {
      const playSound = (id) => { const s = document.getElementById(id); if (s) { s.currentTime = 0; s.play().catch(e => console.warn(`Sound ${id} play failed:`, e)); } };
      const updateButtonText = (buttonElement, baseText) => { if (buttonElement) { const textSpan = buttonElement.querySelector('.button-text') || document.createElement('span'); textSpan.className = 'button-text'; textSpan.textContent = baseText; buttonElement.innerHTML = ''; buttonElement.appendChild(textSpan); }};
      const updateElementText = (el, txt, type) => { if(el) { el.textContent = txt; const baseClasses = el.className.split(' ').filter(c => !['info','success','error','waiting','ready'].includes(c)).join(' '); el.className = baseClasses; if (type) el.classList.add(type); }};
      const showHideElement = (el, show, disp = 'block') => { if(el) el.style.display = show ? disp : 'none'; };
      const disableElement = (el, dis) => { if(el) el.disabled = dis; };

      const allSections = document.querySelectorAll('section');
      const sidebar = document.getElementById('mySidebar');
      const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
      const sidebarCloseButton = document.getElementById('sidebar-close-button');

      const navLoginLinkSidebar = document.getElementById('nav-login-link-sidebar');
      const navUserSearchLinkSidebar = document.getElementById('nav-user-search-link-sidebar');
      const navFriendsLinkSidebar = document.getElementById('nav-friends-link-sidebar');
      const navSettingsLinkSidebar = document.getElementById('nav-settings-link-sidebar');
      const adminButtonSidebar = document.getElementById('admin-button-sidebar');

      let isLoginMode = true;

      const loginTitle = document.getElementById('login-title');
      const mainActionButton = document.getElementById('btn-main-action');
      const toggleAuthModeText = document.getElementById('toggle-auth-mode-text');
      const authFormFields = document.getElementById('auth-form-fields');
      const loginEmailInput = document.getElementById('login-email');
      const loginPasswordInput = document.getElementById('login-password');
      const btnLogout = document.getElementById('btn-logout');
      const authStatusDiv = document.getElementById('auth-status');

      const settingsUserEmailEl = document.getElementById('settings-user-email');
      const settingsUsernameInput = document.getElementById('settings-username');
      const settingsDisplayNameInput = document.getElementById('settings-display-name');
      const settingsBioInput = document.getElementById('settings-bio');
      const btnSaveSettings = document.getElementById('btn-save-settings');
      const profileSettingsStatusDiv = document.getElementById('profile-settings-status');
      const btnChangePassword = document.getElementById('btn-change-password');
      const settingsStatusDiv = document.getElementById('settings-status');

      const userSearchInput = document.getElementById('user-search-input');
      const btnUserSearch = document.getElementById('btn-user-search');
      const userSearchStatusDiv = document.getElementById('user-search-status');
      const searchResultsContainer = document.getElementById('search-results-container');

      const myFriendsListDiv = document.getElementById('my-friends-list');
      const receivedRequestsListDiv = document.getElementById('received-requests-list');
      const sentRequestsListDiv = document.getElementById('sent-requests-list');
      const friendsListStatusDiv = document.querySelector('#friends-section .friends-list-status');
      const receivedRequestsCountSpan = document.getElementById('received-requests-count');


      const chatRoomHeader = document.getElementById('chat-room-header');
      const messagesContainer = document.getElementById('messages-container');
      const messageInput = document.getElementById('message-input');
      const sendMessageButton = document.getElementById('send-message-button');
      const chatRoomExitButton = document.getElementById('chat-room-exit-button');


      const adminUsersListContainer = document.getElementById('admin-users-list-container');
      const adminUserDetailsContainer = document.getElementById('admin-user-details-container');
      const adminStatusDiv = document.getElementById('admin-status');
      const detailsCloseBtn = document.getElementById('details-close-btn');
      if (detailsCloseBtn) detailsCloseBtn.addEventListener('click', () => showHideElement(adminUserDetailsContainer, false));

      const loadUserProfileSettings = async (userId) => {
        if (!settingsUsernameInput || !settingsDisplayNameInput || !settingsBioInput) return;
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                currentUserData = userData; 
                settingsUsernameInput.value = userData.username || '';
                settingsDisplayNameInput.value = userData.displayName || '';
                settingsBioInput.value = userData.bio || '';
            }
        } catch (error) {
            console.error("Error loading user profile settings:", error);
            updateElementText(profileSettingsStatusDiv, "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ.", 'error');
        }
      };

      if (btnSaveSettings) {
        btnSaveSettings.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                updateElementText(profileSettingsStatusDiv, "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.", 'error');
                return;
            }
            const newUsername = settingsUsernameInput.value.trim().toLowerCase();
            const newDisplayName = settingsDisplayNameInput.value.trim();
            const newBio = settingsBioInput.value.trim();

            if (!newUsername) {
                updateElementText(profileSettingsStatusDiv, "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨.", 'error');
                return;
            }
            if (!/^[a-z0-9_]{3,20}$/.test(newUsername)) {
                updateElementText(profileSettingsStatusDiv, "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: 3-20 Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ØµØºÙŠØ±ØŒ Ø£Ø±Ù‚Ø§Ù…ØŒ Ø£Ùˆ '_'.", 'error');
                return;
            }
            if (!newDisplayName) {
                 updateElementText(profileSettingsStatusDiv, "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù…Ø·Ù„ÙˆØ¨.", 'error');
                return;
            }

            updateElementText(profileSettingsStatusDiv, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...", 'info');
            disableElement(btnSaveSettings, true);

            try {
                const usernameQuery = await db.collection('users').where('username', '==', newUsername).get();
                let usernameTaken = false;
                usernameQuery.forEach(doc => {
                    if (doc.id !== user.uid) {
                        usernameTaken = true;
                    }
                });

                if (usernameTaken) {
                    updateElementText(profileSettingsStatusDiv, "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…Ø£Ø®ÙˆØ° Ø¨Ø§Ù„ÙØ¹Ù„.", 'error');
                    disableElement(btnSaveSettings, false);
                    return;
                }

                await db.collection('users').doc(user.uid).set({
                    username: newUsername,
                    displayName: newDisplayName,
                    bio: newBio
                }, { merge: true });
                currentUserData = { ...currentUserData, username: newUsername, displayName: newDisplayName, bio: newBio };
                updateElementText(profileSettingsStatusDiv, "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!", 'success');
            } catch (error) {
                console.error("Error saving profile settings:", error);
                updateElementText(profileSettingsStatusDiv, "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.", 'error');
            } finally {
                disableElement(btnSaveSettings, false);
            }
        });
      }


      const updateUserDocument = (user) => {
          if (!user) return;
          const userDocRef = db.collection('users').doc(user.uid);

          userDocRef.get().then(docSnapshot => {
            const existingData = docSnapshot.exists ? docSnapshot.data() : {};
            const defaultDisplayName = user.email.split('@')[0];

            const dataToSet = {
                email: user.email,
                uid: user.uid,
                displayName: existingData.displayName || defaultDisplayName,
                username: existingData.username || '',
                bio: existingData.bio || '',
                friends: existingData.friends || [],
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                createdAt: existingData.createdAt || (user.metadata.creationTime ? firebase.firestore.Timestamp.fromDate(new Date(user.metadata.creationTime)) : firebase.firestore.FieldValue.serverTimestamp()),
                isBanned: existingData.isBanned || false
            };
             if (existingData.isAdmin) {
                dataToSet.isAdmin = true;
            }

            userDocRef.set(dataToSet, { merge: true })
            .then(() => {
                userDocRef.get().then(doc => {
                    currentUserData = doc.exists ? doc.data() : null;
                    if (doc.exists && doc.data().isAdmin === true) {
                        currentUserIsAdmin = true;
                    } else {
                        currentUserIsAdmin = false;
                    }
                    showHideElement(adminButtonSidebar, currentUserIsAdmin && user.emailVerified);
                    if (user.emailVerified) {
                        loadUserProfileSettings(user.uid);
                        setupFriendSystemListeners(user.uid);
                    }
                }).catch(err => {
                    console.error("Error fetching user admin status:", err);
                    currentUserIsAdmin = false;
                    showHideElement(adminButtonSidebar, false);
                });
            })
            .catch(error => {
                console.error("Error updating user document in Firestore: ", error);
            });

          }).catch(error => {
             console.error("Error getting user document for update: ", error);
          });
      };

      const checkIfUserIsBanned = async (userId) => {
          if (!userId) return false;
          try {
              const userDoc = await db.collection('users').doc(userId).get();
              if (userDoc.exists && userDoc.data().isBanned === true) {
                  return true;
              }
              return false;
          } catch (error) {
              console.error("Error checking ban status:", error);
              // Ø¥Ø°Ø§ Ø­Ø¯Ø« Ø®Ø·Ø£ (Ù…Ø«Ù„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)ØŒ Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø­Ø¸ÙˆØ± Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù‡ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø£Ùˆ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù„ true
              return false; 
          }
      };


       const updateAuthUI = async (isLoggedIn, user, isVerified = true) => {
        showHideElement(authFormFields, !isLoggedIn);
        showHideElement(mainActionButton, !isLoggedIn);
        showHideElement(toggleAuthModeText.parentElement, !isLoggedIn);
        showHideElement(btnLogout, isLoggedIn);

        showHideElement(navLoginLinkSidebar, true);

        let isBanned = false;
        if (isLoggedIn && user) {
            isBanned = await checkIfUserIsBanned(user.uid);
            if (isBanned) {
                updateElementText(authStatusDiv, `Ø­Ø³Ø§Ø¨Ùƒ (${user.email}) Ù…Ø­Ø¸ÙˆØ±. Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚.`, 'error');
                isVerified = false;
                 if (auth.currentUser) {
                    await auth.signOut().catch(e => console.warn("Error signing out banned user", e));
                    return;
                }
            }
        }

        showHideElement(navUserSearchLinkSidebar, isLoggedIn && isVerified);
        showHideElement(navFriendsLinkSidebar, isLoggedIn && isVerified);
        showHideElement(navSettingsLinkSidebar, isLoggedIn && isVerified);

        const currentActiveSection = document.querySelector('section.active');
        const activeSectionId = currentActiveSection ? currentActiveSection.id : 'login';

        if (isLoggedIn) {
          loginTitle.textContent = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ`;
          if (isVerified) {
            updateElementText(authStatusDiv, user.email, 'success');
            if(settingsUserEmailEl) settingsUserEmailEl.textContent = user.email;
            updateUserDocument(user);
          } else if (!isBanned) {
            // Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„ÙƒÙ† Ù„Ù… ÙŠÙØ¹Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
            updateElementText(authStatusDiv, `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.email}. ÙŠØ±Ø¬Ù‰ ÙØ­Øµ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Inbox/Spam) ÙˆØ§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„.`, 'error');
            // Ù†Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®ØµØ§Ø¦Øµ
            if(settingsUserEmailEl) settingsUserEmailEl.textContent = "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø£ÙˆÙ„Ø§Ù‹.";
          }
          navLoginLinkSidebar.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬';
          navLoginLinkSidebar.href = "#logout";
        } else {
          currentUserIsAdmin = false;
          currentUserData = null;
          isLoginMode = true;
          updateLoginModeUI();
          updateElementText(authStatusDiv, 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯.', 'info');
          navLoginLinkSidebar.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
          navLoginLinkSidebar.href = "#login";

          if(settingsUserEmailEl) settingsUserEmailEl.textContent = "ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
          if(settingsUsernameInput) settingsUsernameInput.value = '';
          if(settingsDisplayNameInput) settingsDisplayNameInput.value = '';
          if(settingsBioInput) settingsBioInput.value = '';

          updateElementText(settingsStatusDiv, '', 'info');
          updateElementText(profileSettingsStatusDiv, '', 'info');
          showHideElement(adminButtonSidebar, false);
          allSections.forEach(s => {
                if(s.id !== 'login') s.classList.remove('active');
          });
          clearFriendSystemListeners();
        }
        updateSidebarActiveLink(activeSectionId);
      };

      const updateLoginModeUI = () => {
        const linkId = 'toggle-auth-mode-link-inner';
        if (isLoginMode) {
          loginTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
          updateButtonText(mainActionButton, 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
          toggleAuthModeText.innerHTML = `Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" id="${linkId}">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a>`;
          loginPasswordInput.placeholder = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
        } else {
          loginTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
          updateButtonText(mainActionButton, 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨');
          toggleAuthModeText.innerHTML = `Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <a href="#" id="${linkId}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>`;
          loginPasswordInput.placeholder = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6+ Ø­Ø±ÙˆÙ)";
        }
        const newToggleLink = document.getElementById(linkId);
        if(newToggleLink) newToggleLink.addEventListener('click', toggleMode);
      };

      const toggleMode = (e) => {
        if(e) e.preventDefault();
        isLoginMode = !isLoginMode;
        updateLoginModeUI();
        updateElementText(authStatusDiv, isLoginMode ? 'Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.' : 'Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯.', 'info');
      };

      const handleAuthAction = () => {
        const email = loginEmailInput.value.trim(); const password = loginPasswordInput.value;
        if (!email || !password) { updateElementText(authStatusDiv, "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.", 'error'); return; }
        if (!isLoginMode && password.length < 6) { updateElementText(authStatusDiv, "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø­Ø±ÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.", 'error'); return; }

        updateElementText(authStatusDiv, isLoginMode ? 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...' : 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...', 'info');
        disableElement(mainActionButton, true);

        if (isLoginMode) {
            auth.signInWithEmailAndPassword(email, password)
              .then(async (userCredential) => {
                if (userCredential.user) {
                    const isBanned = await checkIfUserIsBanned(userCredential.user.uid);
                    if (isBanned) {
                        updateElementText(authStatusDiv, "Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ø¸ÙˆØ±.", 'error');
                        auth.signOut();
                    } else if (!userCredential.user.emailVerified) {
                        updateElementText(authStatusDiv, "ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙˆÙ„ÙƒÙ† Ù„Ù… ØªÙ‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ.", 'error');
                        // Ù„Ø§ Ù†Ø³Ø¬Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙˆØ±Ø§Ù‹ Ù„Ù†Ø³Ù…Ø­ Ù„Ù‡Ù… Ø¨Ø±Ø¤ÙŠØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ù„ÙƒÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³ØªÙ‚ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„
                    } else {
                        loginEmailInput.value = ''; loginPasswordInput.value = '';
                    }
                }
              })
              .catch((error) => {
                let msg = "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                if (error.code === 'auth/invalid-api-key' || (error.code === 'auth/internal-error' && error.message.includes("API key not valid"))) {
                    msg = "Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ù…ÙØªØ§Ø­ API ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.";
                } else if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') msg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
                else if (error.code === 'auth/invalid-email') msg = "ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
                console.error("Auth Error Code:",error.code, "Message:", error.message); updateElementText(authStatusDiv, msg, 'error');
              })
              .finally(() => { disableElement(mainActionButton, false); });
        } else {
            auth.createUserWithEmailAndPassword(email, password)
              .then((userCredential) => {
                if (userCredential.user) {
                  userCredential.user.sendEmailVerification()
                    .then(() => {
                      updateElementText(authStatusDiv, 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªÙØ¹ÙŠÙ„ Ù„Ø¨Ø±ÙŠØ¯Ùƒ. Ø§Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡ Ø«Ù… Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„.', 'success');
                      auth.signOut();
                    })
                    .catch((error) => {
                      console.error("Error sending verification email:", error);
                      updateElementText(authStatusDiv, 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ ÙˆÙ„ÙƒÙ† ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚. Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.', 'error');
                       auth.signOut();
                    });
                }
                loginEmailInput.value = ''; loginPasswordInput.value = '';
              })
              .catch((error) => {
                let msg = "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                if (error.code === 'auth/invalid-api-key' || (error.code === 'auth/internal-error' && error.message.includes("API key not valid"))) {
                    msg = "Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ù…ÙØªØ§Ø­ API ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.";
                } else if (error.code === 'auth/email-already-in-use') msg = "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.";
                else if (error.code === 'auth/weak-password') msg = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (6 Ø­Ø±ÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).";
                else if (error.code === 'auth/invalid-email') msg = "ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
                console.error("Auth Error Code:",error.code, "Message:", error.message); updateElementText(authStatusDiv, msg, 'error');
              })
              .finally(() => { disableElement(mainActionButton, false); });
        }
      };
      updateLoginModeUI();
      mainActionButton.addEventListener('click', handleAuthAction);

      btnLogout.addEventListener('click', () => {
        auth.signOut().catch(e => console.error('Logout error', e));
        updateElementText(authStatusDiv, 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯.', 'info');
        window.location.hash = 'login';
        closeSidebar();
      });

      if(btnChangePassword) {
          btnChangePassword.addEventListener('click', () => {
              const user = auth.currentUser;
              if (user && user.email) {
                  auth.sendPasswordResetEmail(user.email)
                      .then(() => {
                          updateElementText(settingsStatusDiv, 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.', 'success');
                      })
                      .catch((error) => {
                          console.error("Error sending password reset email:", error);
                          updateElementText(settingsStatusDiv, 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
                      });
              } else {
                  updateElementText(settingsStatusDiv, 'ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.', 'error');
              }
          });
      }

      if (btnUserSearch) {
        btnUserSearch.addEventListener('click', () => displaySearchResults());
        userSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') displaySearchResults();
        });
      }

      async function displaySearchResults() {
            const searchTerm = userSearchInput.value.trim().toLowerCase();
            if (!searchTerm) {
                updateElementText(userSearchStatusDiv, "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¨Ø­Ø«.", 'error');
                searchResultsContainer.innerHTML = '';
                return;
            }
            updateElementText(userSearchStatusDiv, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...", 'info');
            searchResultsContainer.innerHTML = '';

            try {
                const usersQuery = await db.collection('users').where('username', '>=', searchTerm).where('username', '<=', searchTerm + '\uf8ff').limit(10).get();

                if (usersQuery.empty) {
                     updateElementText(userSearchStatusDiv, "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù….", 'info');
                } else {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;

                    let resultsCount = 0;
                    for (const doc of usersQuery.docs) {
                        const userData = doc.data();
                        if (doc.id === currentUser.uid) continue;
                        resultsCount++;

                        const card = document.createElement('div');
                        card.className = 'user-profile-card';

                        const profilePicDiv = document.createElement('div');
                        profilePicDiv.className = 'profile-pic-default';
                        profilePicDiv.innerHTML = `<i class='bx bxs-user'></i>`;

                        const userInfoDiv = document.createElement('div');
                        userInfoDiv.className = 'user-info';
                        userInfoDiv.innerHTML = `
                            <p class="username-search">@${userData.username || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                            <p>${userData.displayName || 'Ø§Ø³Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            ${userData.bio ? `<p class="bio-search">${userData.bio}</p>` : ''}
                        `;

                        const userActionsDiv = document.createElement('div');
                        userActionsDiv.className = 'user-actions';

                        const chatButton = document.createElement('button');
                        chatButton.textContent = 'Ù…Ø­Ø§Ø¯Ø«Ø©';
                        chatButton.onclick = () => initiateChat(doc.id, userData.displayName || userData.username);
                        userActionsDiv.appendChild(chatButton);

                        const friendButton = await createFriendButton(doc.id, userData.username);
                        if (friendButton) userActionsDiv.appendChild(friendButton);


                        card.appendChild(profilePicDiv);
                        card.appendChild(userInfoDiv);
                        card.appendChild(userActionsDiv);
                        searchResultsContainer.appendChild(card);
                    }
                    if (resultsCount > 0) {
                         updateElementText(userSearchStatusDiv, `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${resultsCount} Ù…Ø³ØªØ®Ø¯Ù…/Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.`, 'success');
                    } else {
                         updateElementText(userSearchStatusDiv, "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†ÙØ³Ùƒ).", 'info');
                    }
                }
            } catch (error) {
                console.error("Error searching users:", error);
                updateElementText(userSearchStatusDiv, "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.", 'error');
            }
      }

      async function createFriendButton(targetUserId, targetUsername) {
        const currentUser = auth.currentUser;
        if (!currentUser || !currentUserData) return null;

        const button = document.createElement('button');

        if (currentUserData.friends && currentUserData.friends.includes(targetUserId)) {
            button.textContent = 'Ø£ØµØ¯Ù‚Ø§Ø¡';
            button.disabled = true;
            return button;
        }

        const sentRequestQuery = await db.collection('friendRequests')
            .where('senderId', '==', currentUser.uid)
            .where('receiverId', '==', targetUserId)
            .where('status', '==', 'pending')
            .limit(1).get();

        if (!sentRequestQuery.empty) {
            button.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
            button.disabled = true;
            return button;
        }

        const receivedRequestQuery = await db.collection('friendRequests')
            .where('senderId', '==', targetUserId)
            .where('receiverId', '==', currentUser.uid)
            .where('status', '==', 'pending')
            .limit(1).get();

        if (!receivedRequestQuery.empty) {
            button.textContent = 'Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨';
            button.style.backgroundColor = '#28a745';
            button.onclick = async () => {
                await handleFriendRequest(receivedRequestQuery.docs[0].id, 'accepted');
                displaySearchResults();
            };
            return button;
        }

        button.textContent = 'Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚';
        button.onclick = async () => {
            await sendFriendRequest(targetUserId);
            displaySearchResults();
        };
        return button;
      }


      const initiateChat = (otherUid, otherDisplayName) => {
        const currentUser = auth.currentUser;
        if (!currentUser) return;

        currentChatWithUserId = otherUid;
        currentChatWithDisplayName = otherDisplayName || 'Ù…Ø³ØªØ®Ø¯Ù…';

        const uids = [currentUser.uid, otherUid].sort();
        currentChatRoomId = uids.join('_');

        if(chatRoomHeader) chatRoomHeader.textContent = `Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${currentChatWithDisplayName}`;
        if(messagesContainer) messagesContainer.innerHTML = '';
        if(messageInput) messageInput.value = '';

        window.location.hash = `chat-room`;
        loadChatMessages(currentChatRoomId);
      };

      const loadChatMessages = (chatId) => {
        if (chatMessagesListener) {
            chatMessagesListener();
        }
        if (!messagesContainer) return;
        messagesContainer.innerHTML = '<p id="chat-loading-msg" style="text-align:center; color:#777;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</p>';
        let firstSnapshotProcessed = false;

        chatMessagesListener = db.collection('chats').doc(chatId).collection('messages')
            .orderBy('timestamp')
            .onSnapshot(snapshot => {
                const loadingMsg = messagesContainer.querySelector('#chat-loading-msg');
                if (loadingMsg) loadingMsg.remove();

                if (!firstSnapshotProcessed && snapshot.empty && messagesContainer.children.length === 0) {
                     messagesContainer.innerHTML = '<p style="text-align:center; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©!</p>';
                }
                firstSnapshotProcessed = true;

                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const existingMsgEl = messagesContainer.querySelector(`[data-message-id="${change.doc.id}"]`);
                        if (!existingMsgEl) {
                           displayMessage(change.doc.data(), change.doc.id);
                        }
                        if(auth.currentUser && change.doc.data().senderId !== auth.currentUser.uid && document.hidden) {
                             playSound('snd-message');
                        }
                    }
                });
                if (messagesContainer.children.length > 0 && messagesContainer.scrollHeight > messagesContainer.clientHeight) {
                     setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0); // Ensure scroll after DOM update
                }
            }, error => {
                console.error("Error fetching chat messages: ", error);
                messagesContainer.innerHTML = '<p style="text-align:center; color:red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„. (Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø¥Ù†Ø´Ø§Ø¡ Index ÙÙŠ Firestore)</p>';
            });
      };

      const displayMessage = (msgData, messageId) => {
        if (!messagesContainer || !auth.currentUser) return;
        const msgBubble = document.createElement('div');
        msgBubble.classList.add('message-bubble');
        msgBubble.dataset.messageId = messageId;

        const isSentByCurrentUser = msgData.senderId === auth.currentUser.uid;
        msgBubble.classList.add(isSentByCurrentUser ? 'sent' : 'received');

        const textNode = document.createElement('span');
        textNode.textContent = msgData.text;
        msgBubble.appendChild(textNode);

        if (msgData.timestamp && msgData.timestamp.toDate) {
            const timestampNode = document.createElement('span');
            timestampNode.classList.add('message-timestamp');
            timestampNode.textContent = new Date(msgData.timestamp.toDate()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            msgBubble.appendChild(timestampNode);
        }

        messagesContainer.appendChild(msgBubble);
        if (messagesContainer.scrollHeight > messagesContainer.clientHeight) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      };

      if (sendMessageButton && messageInput) {
        const handleSendMessage = async () => {
            const text = messageInput.value.trim();
            if (text === '' || !currentChatRoomId || !auth.currentUser) return;
            const tempMessageId = 'temp_' + Date.now();
            messageInput.value = '';

            try {
                await db.collection('chats').doc(currentChatRoomId).collection('messages').add({
                    text: text,
                    senderId: auth.currentUser.uid,
                    receiverId: currentChatWithUserId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending message: ", error);
                const tempMsgEl = messagesContainer.querySelector(`[data-message-id="${tempMessageId}"]`);
                if(tempMsgEl) tempMsgEl.style.backgroundColor = 'lightcoral';
            }
        };
        sendMessageButton.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSendMessage();
            }
        });
      }

      if(chatRoomExitButton) {
        chatRoomExitButton.addEventListener('click', () => {
            if (chatMessagesListener) {
                chatMessagesListener();
                chatMessagesListener = null;
            }
            currentChatRoomId = null;
            currentChatWithUserId = null;
            currentChatWithDisplayName = null;
            window.location.hash = 'user-search';
        });
      }

      const displayUsersForAdmin = () => {
          if (!adminUsersListContainer) return;
          adminUsersListContainer.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>';
          updateElementText(adminStatusDiv, '', 'info');

          db.collection('users').orderBy('createdAt', 'desc').get()
              .then(querySnapshot => {
                  if (querySnapshot.empty) {
                      adminUsersListContainer.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù„Ø¹Ø±Ø¶Ù‡Ù….</p>';
                      return;
                  }
                  let html = '<ul>';
                  querySnapshot.forEach(doc => {
                      const userData = doc.data();
                      const isAdminText = userData.isAdmin ? ' (Ø£Ø¯Ù…Ù†)' : '';
                      const bannedIndicator = userData.isBanned ? '<span class="banned-user-indicator"> (Ù…Ø­Ø¸ÙˆØ±)</span>' : '';
                      const disableBanForSelfOrOtherAdmins = (userData.uid === auth.currentUser.uid || userData.isAdmin) && auth.currentUser.email !== ADMIN_EMAIL ;

                      html += `<li>
                                 <span>${userData.displayName || userData.username || userData.email}${isAdminText}${bannedIndicator}</span>
                                 <div class="user-actions">
                                     <button onclick="viewUserDetails('${doc.id}')">ØªÙØ§ØµÙŠÙ„</button>
                                     <button onclick="toggleUserBanStatus('${doc.id}', ${userData.isBanned || false})"
                                             ${disableBanForSelfOrOtherAdmins ? 'disabled title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨"' : ''}>
                                         ${userData.isBanned ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'}
                                     </button>
                                 </div>
                               </li>`;
                  });
                  html += '</ul>';
                  adminUsersListContainer.innerHTML = html;
              })
              .catch(error => {
                  console.error("Error fetching users for admin:", error);
                  adminUsersListContainer.innerHTML = '<p>Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</p>';
                  if (error.code === 'permission-denied') {
                      adminUsersListContainer.innerHTML += '<br><b>ØªØ­Ø°ÙŠØ±:</b> Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„.';
                  }
                  updateElementText(adminStatusDiv, 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†. ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Firestore.', 'error');
              });
      };

      window.viewUserDetails = (userId) => {
          db.collection('users').doc(userId).get().then(doc => {
              if (doc.exists) {
                  const data = doc.data();
                  document.getElementById('details-email').textContent = `Ø§Ù„Ø¨Ø±ÙŠØ¯: ${data.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}`;
                  document.getElementById('details-uid').textContent = `UID: ${data.uid || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}`;
                  document.getElementById('details-username').textContent = `Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${data.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
                  document.getElementById('details-displayName').textContent = `Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: ${data.displayName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
                  document.getElementById('details-bio').textContent = `Ø§Ù„Ù†Ø¨Ø°Ø©: ${data.bio || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}`;
                  document.getElementById('details-created').textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleString() : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}`;
                  document.getElementById('details-last-login').textContent = `Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„: ${data.lastLogin ? new Date(data.lastLogin.toDate()).toLocaleString() : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}`;
                  document.getElementById('details-banned-status').textContent = `Ø§Ù„Ø­Ø§Ù„Ø©: ${data.isBanned ? 'Ù…Ø­Ø¸ÙˆØ±' : 'Ù†Ø´Ø·'}${data.isAdmin ? ' (Ø£Ø¯Ù…Ù†)' : ''}`;
                  showHideElement(adminUserDetailsContainer, true);
              } else {
                  updateElementText(adminStatusDiv, 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'error');
              }
          }).catch(err => {
              console.error("Error fetching user details:", err);
              updateElementText(adminStatusDiv, 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'error');
          });
      };

      window.toggleUserBanStatus = (userIdToManage, currentBanStatus) => {
          if (auth.currentUser && userIdToManage === auth.currentUser.uid) {
              updateElementText(adminStatusDiv, 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¸Ø± Ù†ÙØ³Ùƒ.', 'error');
              return;
          }
          db.collection('users').doc(userIdToManage).get().then(doc => {
            if (doc.exists && doc.data().isAdmin && auth.currentUser && auth.currentUser.email !== ADMIN_EMAIL) {
                updateElementText(adminStatusDiv, 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨ Ø£Ø¯Ù…Ù† Ø¢Ø®Ø±.', 'error');
                return;
            }

            const newBanStatus = !currentBanStatus;
            db.collection('users').doc(userIdToManage).update({
                isBanned: newBanStatus
            })
            .then(() => {
                updateElementText(adminStatusDiv, `ØªÙ… ${newBanStatus ? 'Ø­Ø¸Ø±' : 'Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±'} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.`, 'success');
                displayUsersForAdmin();
                showHideElement(adminUserDetailsContainer, false);
            })
            .catch(error => {
                console.error("Error updating ban status:", error);
                updateElementText(adminStatusDiv, 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±.', 'error');
            });
          }).catch(err => {
             console.error("Error checking if target user is admin:", err);
             updateElementText(adminStatusDiv, 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‡Ø¯Ù.', 'error');
          });
      };


      window.showAdminArea = (event) => {
          event.preventDefault();
          if (currentUserIsAdmin) {
              window.location.hash = "admin-area";
              displayUsersForAdmin();
          } else {
              alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©.");
              window.location.hash = "user-search";
          }
          closeSidebar();
      };

      const updateSidebarActiveLink = (activeSectionId) => {
        const links = sidebar.querySelectorAll('a');
        links.forEach(a => {
            if (a) a.classList.remove('active-nav-link');
            if (a && a.getAttribute('href') === `#${activeSectionId}`) {
                a.classList.add('active-nav-link');
            }
        });
        if (activeSectionId === 'login' && !auth.currentUser) {
            if(navLoginLinkSidebar) navLoginLinkSidebar.classList.add('active-nav-link');
        }
      };

      const showSectionByHash = async () => {
        let hash = window.location.hash.slice(1);
        const currentUser = auth.currentUser;

        if (hash.startsWith('chat-room') && currentChatRoomId) {
             if(chatRoomHeader) chatRoomHeader.textContent = `Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${currentChatWithDisplayName || '...'}`;
             if (!chatMessagesListener) {
                loadChatMessages(currentChatRoomId);
             }
        } else if (!hash.startsWith('chat-room') && chatMessagesListener) {
            chatMessagesListener();
            chatMessagesListener = null;
            currentChatRoomId = null;
            currentChatWithUserId = null;
            currentChatWithDisplayName = null;
        }


        let isBanned = false;
        let isVerified = false;

        if (currentUser) {
            isVerified = currentUser.emailVerified;
            isBanned = await checkIfUserIsBanned(currentUser.uid);
            if (isBanned) {
                isVerified = false;
                if (hash !== 'login') {
                     window.location.hash = 'login';
                     return;
                }
            }
        }


        if (!hash) {
            if (isVerified) {
                hash = 'user-search';
            } else {
                hash = 'login';
            }
            if (window.location.hash.slice(1) !== hash) {
                window.location.hash = hash;
                return;
            }
        }

        let targetIdToShow = 'login';
        if (isVerified) {
            if (hash === 'settings' || hash === 'user-search' || hash === 'friends-section' || (hash === 'chat-room' && currentChatRoomId) ) {
                targetIdToShow = hash;
            } else if (hash === 'admin-area' && currentUserIsAdmin) {
                targetIdToShow = hash;
                displayUsersForAdmin();
            } else {
                targetIdToShow = 'user-search';
                if (window.location.hash !== '#user-search') window.location.hash = 'user-search';
            }
        } else {
            if (hash !== 'login' && hash !== '') {
                 if (window.location.hash !== '#login') window.location.hash = 'login';
                 targetIdToShow = 'login';
            } else {
                targetIdToShow = 'login';
            }
        }

        allSections.forEach(s => {
            if (s.id === targetIdToShow) {
                s.classList.add('active');
            } else {
                s.classList.remove('active');
            }
        });
        updateSidebarActiveLink(targetIdToShow);
        if (targetIdToShow === 'settings' && settingsStatusDiv) updateElementText(settingsStatusDiv, '', 'info');
        if (targetIdToShow === 'settings' && profileSettingsStatusDiv) updateElementText(profileSettingsStatusDiv, 'Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ.', 'info');
        if (targetIdToShow === 'admin-area' && adminStatusDiv) updateElementText(adminStatusDiv, 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø£Ø¯Ù…Ù†.', 'info');
        if (targetIdToShow === 'user-search' && userSearchStatusDiv) updateElementText(userSearchStatusDiv, 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¨Ø­Ø«.', 'info');
        if (targetIdToShow === 'friends-section') {
            showFriendsTab('my-friends');
            loadFriendsData();
        }
      };

      auth.onAuthStateChanged(async user => {
        await updateAuthUI(!!user, user, user ? user.emailVerified : false);

        if(user && user.emailVerified) {
            const userDoc = await db.collection('users').doc(user.uid).get().catch(() => null);
            currentUserData = userDoc && userDoc.exists ? userDoc.data() : null;
            currentUserIsAdmin = currentUserData && currentUserData.isAdmin === true;
            if (settingsUsernameInput && settingsDisplayNameInput) {
                loadUserProfileSettings(user.uid);
            }
            setupFriendSystemListeners(user.uid);
        } else {
            currentUserIsAdmin = false;
            currentUserData = null;
            clearFriendSystemListeners();
        }
        showHideElement(adminButtonSidebar, currentUserIsAdmin && user && user.emailVerified);

        showSectionByHash();
      });

      const handleSidebarLinkClick = (e) => {
          e.preventDefault();
          const targetHash = e.currentTarget.getAttribute('href');
          if (targetHash === '#logout') {
            auth.signOut().then(() => {
                 currentUserIsAdmin = false;
                 currentUserData = null;
                 if (chatMessagesListener) { chatMessagesListener(); chatMessagesListener = null; }
                 clearFriendSystemListeners();
                 currentChatRoomId = null; currentChatWithUserId = null; currentChatWithDisplayName = null;
                 window.location.hash = 'login';
            }).catch(err => console.error('Logout error', err));
          } else {
            window.location.hash = targetHash;
          }
          closeSidebar();
      };

      navLoginLinkSidebar.addEventListener('click', handleSidebarLinkClick);
      if (navUserSearchLinkSidebar) navUserSearchLinkSidebar.addEventListener('click', handleSidebarLinkClick);
      if (navFriendsLinkSidebar) navFriendsLinkSidebar.addEventListener('click', handleSidebarLinkClick);
      if (navSettingsLinkSidebar) navSettingsLinkSidebar.addEventListener('click', handleSidebarLinkClick);

      window.addEventListener('hashchange', showSectionByHash);

      function openSidebar() { if(sidebar) sidebar.classList.add('open'); }
      function closeSidebar() { if(sidebar) sidebar.classList.remove('open'); }
      if(sidebarToggleButton) sidebarToggleButton.addEventListener('click', openSidebar);
      if(sidebarCloseButton) sidebarCloseButton.addEventListener('click', closeSidebar);
      document.addEventListener('click', function(event) {
        if (sidebar && sidebar.classList.contains('open') &&
            !sidebar.contains(event.target) &&
            !sidebarToggleButton.contains(event.target)) {
            closeSidebar();
        }
      });

      // Friend System Functions
      async function sendFriendRequest(receiverId) {
        const currentUser = auth.currentUser;
        if (!currentUser || !currentUserData || currentUser.uid === receiverId) return;

        try {
            const existingRequestQuery = await db.collection('friendRequests')
                .where('senderId', '==', currentUser.uid)
                .where('receiverId', '==', receiverId)
                .limit(1).get();

            const existingReceivedRequestQuery = await db.collection('friendRequests')
                .where('senderId', '==', receiverId)
                .where('receiverId', '==', currentUser.uid)
                .limit(1).get();

            if (!existingRequestQuery.empty || !existingReceivedRequestQuery.empty) {
                console.log("Friend request already exists or received.");
                updateElementText(userSearchStatusDiv, "Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ù…Ù†Ùƒ.", 'info');
                return;
            }

            await db.collection('friendRequests').add({
                senderId: currentUser.uid,
                senderUsername: currentUserData.username || 'Ù…Ø¬Ù‡ÙˆÙ„',
                senderDisplayName: currentUserData.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…',
                receiverId: receiverId,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            playSound('snd-friend-request');
            updateElementText(userSearchStatusDiv, "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!", 'success');
        } catch (error) {
            console.error("Error sending friend request:", error);
            updateElementText(userSearchStatusDiv, "Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©.", 'error');
        }
      }

      async function handleFriendRequest(requestId, newStatus) {
        const currentUser = auth.currentUser;
        if (!currentUser) return;
        try {
            const requestRef = db.collection('friendRequests').doc(requestId);
            const requestDoc = await requestRef.get();
            if (!requestDoc.exists) return;
            const requestData = requestDoc.data();

            if (requestData.receiverId !== currentUser.uid && newStatus !== 'cancelled') {
                 console.error("Not authorized to handle this request"); return;
            }
             if (newStatus === 'cancelled' && requestData.senderId !== currentUser.uid) {
                console.error("Not authorized to cancel this request"); return;
            }


            await requestRef.update({
                status: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            if (newStatus === 'accepted') {
                const batch = db.batch();
                const user1Ref = db.collection('users').doc(requestData.senderId);
                const user2Ref = db.collection('users').doc(requestData.receiverId);

                batch.update(user1Ref, { friends: firebase.firestore.FieldValue.arrayUnion(requestData.receiverId) });
                batch.update(user2Ref, { friends: firebase.firestore.FieldValue.arrayUnion(requestData.senderId) });
                await batch.commit();
                updateElementText(friendsListStatusDiv, `Ø£ØµØ¨Ø­ ${requestData.senderDisplayName} ØµØ¯ÙŠÙ‚Ùƒ!`, 'success');
            } else if (newStatus === 'rejected') {
                 updateElementText(friendsListStatusDiv, `ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ù…Ù† ${requestData.senderDisplayName}.`, 'info');
            } else if (newStatus === 'cancelled') {
                 updateElementText(friendsListStatusDiv, `ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©.`, 'info');
            }
             playSound('snd-click');
        } catch (error) {
            console.error("Error handling friend request:", error);
            updateElementText(friendsListStatusDiv, "Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©.", 'error');
        }
      }


      function setupFriendSystemListeners(userId) {
        clearFriendSystemListeners();

        friendsListener = db.collection('users').doc(userId)
            .onSnapshot(async (doc) => {
                if (doc.exists) {
                    currentUserData = doc.data(); // Keep currentUserData synced
                    const friendsUids = doc.data().friends || [];
                    await displayFriendsList(friendsUids, myFriendsListDiv, 'friend');
                }
            }, err => console.error("Error listening to friends:", err));

        receivedRequestsListener = db.collection('friendRequests')
            .where('receiverId', '==', userId)
            .where('status', '==', 'pending')
            .orderBy('createdAt', 'desc')
            .onSnapshot(async (snapshot) => {
                const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                await displayFriendsList(requests, receivedRequestsListDiv, 'received');
                if(receivedRequestsCountSpan) receivedRequestsCountSpan.textContent = requests.length;
            }, err => console.error("Error listening to received requests:", err));

        sentRequestsListener = db.collection('friendRequests')
            .where('senderId', '==', userId)
            .where('status', '==', 'pending')
            .orderBy('createdAt', 'desc')
            .onSnapshot(async (snapshot) => {
                const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                await displayFriendsList(requests, sentRequestsListDiv, 'sent');
            }, err => console.error("Error listening to sent requests:", err));
      }

      function clearFriendSystemListeners() {
        if (friendsListener) friendsListener();
        if (receivedRequestsListener) receivedRequestsListener();
        if (sentRequestsListener) sentRequestsListener();
        friendsListener = null; receivedRequestsListener = null; sentRequestsListener = null;
        if(receivedRequestsCountSpan) receivedRequestsCountSpan.textContent = '0';
      }

      async function displayFriendsList(items, container, type) {
        if (!container) return;
        container.innerHTML = '';
        if (items.length === 0) {
            let msg = '';
            if (type === 'friend') msg = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¬Ø¯Ø¯!';
            else if (type === 'received') msg = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØµØ¯Ø§Ù‚Ø© ÙˆØ§Ø±Ø¯Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.';
            else if (type === 'sent') msg = 'Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª ØµØ¯Ø§Ù‚Ø© Ù…Ø¹Ù„Ù‚Ø©.';
            container.innerHTML = `<p style="text-align:center; padding:10px; color:#777;">${msg}</p>`;
            return;
        }

        for (const item of items) {
            let userData, requestId;
            if (type === 'friend') { // item is a UID
                const userDoc = await db.collection('users').doc(item).get();
                if (!userDoc.exists) continue;
                userData = userDoc.data();
                userData.uid = item;
            } else { // item is a request object
                requestId = item.id;
                if (type === 'received') {
                    userData = { uid: item.senderId, username: item.senderUsername, displayName: item.senderDisplayName };
                } else { // sent
                     const userDoc = await db.collection('users').doc(item.receiverId).get();
                     if (!userDoc.exists) continue;
                     userData = userDoc.data();
                     userData.uid = item.receiverId;
                }
            }


            const listItem = document.createElement('div');
            listItem.className = 'friends-list-item';

            const picDiv = document.createElement('div');
            picDiv.className = 'profile-pic-default';
            picDiv.innerHTML = `<i class='bx bxs-user'></i>`;

            const infoDiv = document.createElement('div');
            infoDiv.className = 'user-info';
            infoDiv.innerHTML = `<p class="username-friend">@${userData.username || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p><p>${userData.displayName || 'Ø§Ø³Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>`;

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'friend-actions';

            if (type === 'friend') {
                const chatBtn = document.createElement('button');
                chatBtn.textContent = 'Ù…Ø­Ø§Ø¯Ø«Ø©';
                chatBtn.onclick = () => initiateChat(userData.uid, userData.displayName || userData.username);
                actionsDiv.appendChild(chatBtn);

                const unfriendBtn = document.createElement('button');
                unfriendBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ø§Ù‚Ø©';
                unfriendBtn.style.backgroundColor = '#dc3545';
                unfriendBtn.onclick = () => unfriendUser(userData.uid);
                actionsDiv.appendChild(unfriendBtn);

            } else if (type === 'received') {
                const acceptBtn = document.createElement('button');
                acceptBtn.textContent = 'Ù‚Ø¨ÙˆÙ„';
                acceptBtn.style.backgroundColor = '#28a745';
                acceptBtn.onclick = () => handleFriendRequest(requestId, 'accepted');
                actionsDiv.appendChild(acceptBtn);

                const rejectBtn = document.createElement('button');
                rejectBtn.textContent = 'Ø±ÙØ¶';
                rejectBtn.style.backgroundColor = '#dc3545';
                rejectBtn.onclick = () => handleFriendRequest(requestId, 'rejected');
                actionsDiv.appendChild(rejectBtn);
            } else if (type === 'sent') {
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨';
                cancelBtn.onclick = () => handleFriendRequest(requestId, 'cancelled');
                actionsDiv.appendChild(cancelBtn);
            }

            listItem.appendChild(picDiv);
            listItem.appendChild(infoDiv);
            listItem.appendChild(actionsDiv);
            container.appendChild(listItem);
        }
      }

      async function unfriendUser(friendUid) {
        const currentUser = auth.currentUser;
        if (!currentUser || !friendUid) return;

        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) return;

        try {
            const batch = db.batch();
            const currentUserRef = db.collection('users').doc(currentUser.uid);
            const friendUserRef = db.collection('users').doc(friendUid);

            batch.update(currentUserRef, { friends: firebase.firestore.FieldValue.arrayRemove(friendUid) });
            batch.update(friendUserRef, { friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });

            // Also remove/reject any pending requests between them, just in case
            const reqQuery1 = db.collection('friendRequests')
                .where('senderId', '==', currentUser.uid).where('receiverId', '==', friendUid);
            const reqQuery2 = db.collection('friendRequests')
                .where('senderId', '==', friendUid).where('receiverId', '==', currentUser.uid);

            const [snap1, snap2] = await Promise.all([reqQuery1.get(), reqQuery2.get()]);
            snap1.forEach(doc => batch.delete(doc.ref));
            snap2.forEach(doc => batch.delete(doc.ref));

            await batch.commit();
            updateElementText(friendsListStatusDiv, `ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­.`, 'success');
            playSound('snd-click');
        } catch (error) {
            console.error("Error unfriending user:", error);
            updateElementText(friendsListStatusDiv, "Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ø§Ù‚Ø©.", 'error');
        }
      }


      window.showFriendsTab = (tabName) => {
        document.querySelectorAll('#friends-section .tabs button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#friends-section .friends-tab-content').forEach(content => content.style.display = 'none');

        document.getElementById(`tab-${tabName}`).classList.add('active');
        document.getElementById(`${tabName}-list`).style.display = 'block';
        updateElementText(friendsListStatusDiv, '', 'info');
      }

      function loadFriendsData() {
        const currentUser = auth.currentUser;
        if (currentUser && currentUser.emailVerified) {
            // Listeners are already set up by setupFriendSystemListeners if user is logged in
            // This function can be used to manually refresh if needed, but listeners should handle it
        } else {
            if(myFriendsListDiv) myFriendsListDiv.innerHTML = '<p>ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡.</p>';
            if(receivedRequestsListDiv) receivedRequestsListDiv.innerHTML = '';
            if(sentRequestsListDiv) sentRequestsListDiv.innerHTML = '';
        }
      }

      showSectionByHash();
    });
  </script>
</body>
</html>
